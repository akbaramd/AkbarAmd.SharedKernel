# GitLab CI/CD - Runs PowerShell script only
# GitLab CI/CD variable (set in GitLab UI: Settings → CI/CD → Variables)
# IMPORTANT: Set the variable name in GitLab as "NUGETKEY" (all uppercase)
# The variable will be available as $NUGETKEY in the environment

publish-nuget:
  image: mcr.microsoft.com/dotnet/sdk:8.0
  before_script:
    # Install PowerShell Core for Linux
    - apt-get update && apt-get install -y wget apt-transport-https software-properties-common
    - wget -q https://packages.microsoft.com/config/ubuntu/20.04/packages-microsoft-prod.deb
    - dpkg -i packages-microsoft-prod.deb
    - apt-get update && apt-get install -y powershell
  script:
    # Check and set NUGETKEY environment variable
    # GitLab CI variables are case-sensitive - check common variations
    - |
      if [ -z "$NUGETKEY" ] && [ -z "$NugetKey" ] && [ -z "$NUGET_API_KEY" ]; then
        echo "ERROR: No NuGet API key found!"
        echo "Please set one of these variables in GitLab: Settings → CI/CD → Variables"
        echo "  - NUGETKEY (recommended)"
        echo "  - NugetKey"
        echo "  - NUGET_API_KEY"
        echo ""
        echo "Available environment variables (filtered for 'nuget'):"
        env | grep -i nuget || echo "  (none found)"
        exit 1
      fi
      # Use the first available variable
      if [ -n "$NUGETKEY" ]; then
        export NUGETKEY="$NUGETKEY"
        echo "Using NUGETKEY variable (length: ${#NUGETKEY})"
      elif [ -n "$NugetKey" ]; then
        export NUGETKEY="$NugetKey"
        echo "Using NugetKey variable (length: ${#NUGETKEY})"
      elif [ -n "$NUGET_API_KEY" ]; then
        export NUGETKEY="$NUGET_API_KEY"
        echo "Using NUGET_API_KEY variable (length: ${#NUGETKEY})"
      fi
    # Run PowerShell script - environment variables are inherited
    - pwsh -File ./Publish-Packages.ps1 -PublishToNuGet -SkipConfirmation
  artifacts:
    paths:
      - nupkgs/*.nupkg
      - nupkgs/*.snupkg
    expire_in: 30 days
  only:
    - main
    - master
    - tags
  # Change to 'on_success' if you want automatic publishing (currently manual for safety)
  when: manual

